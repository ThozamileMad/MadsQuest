-- Scenes Table
CREATE TABLE scenes (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    image_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Choices Table
CREATE TABLE choices (
    id SERIAL PRIMARY KEY,
    scene_id INT NOT NULL REFERENCES scenes(id) ON DELETE CASCADE,
    icon TEXT, 
    choice_text TEXT NOT NULL,
    next_scene_id INT NOT NULL REFERENCES scenes(id) ON DELETE CASCADE
);


-- Choice Effects Table
CREATE TABLE choice_effects (
    id SERIAL PRIMARY KEY,
    choice_id INT NOT NULL REFERENCES choices(id) ON DELETE CASCADE,
    life_change INT DEFAULT 0,
    mana_change INT DEFAULT 0,
    morale_change INT DEFAULT 0,
    coin_change INT DEFAULT 0
);

-- Player Stats Table (users)
CREATE TABLE player_stats (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    life INT DEFAULT 100,
    mana INT DEFAULT 50,
    morale INT DEFAULT 50,
    coin INT DEFAULT 0,
    last_updated TIMESTAMP DEFAULT NOW()
);


-- Player Stats Table
CREATE TABLE player_stats (
    id SERIAL PRIMARY KEY,
    life INT DEFAULT 100,
    mana INT DEFAULT 50,
    morale INT DEFAULT 50,
    coin INT DEFAULT 0,
    last_updated TIMESTAMP DEFAULT NOW()
);

// Scene 1
BEGIN;

WITH new_scene AS (
  INSERT INTO scenes (title, content, image_url)
  VALUES (
    'The Fortress Raid',
    'Oh! The Gods shall cast me into hell for recruiting this lunatic.\n\nVictor‚Äîthis psychotic animal just mutilated Horin''s wife and child with his bare hands. Currently, we''re attempting to loot coin from Horin''s keep while the castellan is away. So far, the paralysis spell I''ve been harnessing for two weeks has proven effective. All of Horin''s men lie helplessly on the ground, conscious but immobilized, as we plunder his hold.\n\nImmediately after Victor''s diabolical act, Horin''s men begin cursing, screaming, and weeping clamorously from where they lie frozen. The sound echoes through the stone halls like a chorus of the damned.\n\n\"You psychotic fool! Have you the slightest capacity to think?\" I roar with uncontrollable fury. \"Unbelievable‚Äîwith your bare hands, a woman and a child! When we''re finished here, I''ll return you to the hell you came from! Mark my words!\"\n\n\"You would cry for a degenerate harlot and her filthy offspring? Spare me the nonsense, Sigarus,\" Victor remarks smugly, that sick smile spreading across his blood-stained face. \"Now let''s get to work.\"\n\nAs much as I want to slaughter him where he stands, I cannot. Time is against us. We must make haste and find Horin''s fortune before he returns with his witch, or before the spell‚Äîwhich consumed nearly all my mana to cast‚Äîdissipates.\n\n\"Have you forgotten why we''re here?\" I snap. \"Search for treasure, you fool! I need not remind you who this fortress belongs to.\"\n\nHe laughs without a shred of concern. \"Very well then. Conduct a search on this floor, and I''ll take to the stairs.\"',
    NULL
  )
  RETURNING id
),
new_choice AS (
  INSERT INTO choices (scene_id, icon, choice_text, next_scene_id)
  SELECT id, '‚öîÔ∏è', 'Continue', id
  FROM new_scene
  RETURNING id
)
INSERT INTO choice_effects (choice_id, life_change, mana_change, morale_change, coin_change)
SELECT id, 0, 0, 0, 0
FROM new_choice
RETURNING *;

COMMIT;


// Scene 2
BEGIN;

WITH new_scene AS (
  INSERT INTO scenes (title, content, image_url)
  VALUES (
    'The Guarded Door',
    'I step over numerous angry guards sprawled across the floor and make my way into a passage lit by burning lanterns that illuminate the path ahead. Their flames cast dancing shadows against the stone walls.\n\nAhead, I see an expensive-looking door adorned with sophisticated carvings and metalwork. That must be an important room, I think to myself as I observe its splendor. Likely where Horin keeps his most valuable possessions.\n\n\"Whoever you are, know this‚Äîyour foolishness will be your undoing,\" a deep voice rumbles from below. \"Horin shan''t rest until you''re dead, so breathe while you still can, thief. Death looms closely upon you like a shadow.\"\n\nThe words come from a massive guard lying vulnerably on his back directly in front of the ornate door. Despite his paralysis, his eyes burn with defiance and rage. A large keychain is tied to his belt, the iron keys gleaming in the lantern light. He cannot move, but his spirit remains unbroken.\n\nThe keys are within reach. How will you take them?',
    NULL
  )
  RETURNING id
),
insert_choices AS (
  INSERT INTO choices (scene_id, icon, choice_text, next_scene_id)
  SELECT ns.id, v.icon, v.text, ns.id
  FROM new_scene ns
  CROSS JOIN (VALUES
    ('ü§ù','Take the keys peacefully'),
    ('‚öîÔ∏è','Take the keys violently'),
    ('üòà','Take the keys dishonorably')
  ) AS v(icon, text)
  RETURNING id, choice_text
)
INSERT INTO choice_effects (choice_id, life_change, mana_change, morale_change, coin_change)
SELECT ic.id,
       0 AS life_change,
       0 AS mana_change,
       CASE ic.choice_text
         WHEN 'Take the keys peacefully' THEN 1
         WHEN 'Take the keys violently' THEN -2
         WHEN 'Take the keys dishonorably' THEN -3
         ELSE 0
       END AS morale_change,
       0 AS coin_change
FROM insert_choices ic
RETURNING *;

COMMIT;


// Scene 3 choices outcomes
BEGIN;

-- Scene 3A: The Peaceful Path
WITH scene3a AS (
  INSERT INTO scenes (title, content, image_url)
  VALUES (
    'The Peaceful Path (Following Choice 1)',
    '"You know, I could kill you right now‚ÄîHenry," I remark, staring down at him after lowering myself to grab the keychain.\n\nHe flinches in surprise, his eyes widening. "How the hell do you know my na‚Äî"\n\n"However, I shall not," I assert, interrupting him. "For I know your beautiful wife, Pholia, prepares a delicious stew for you and your children, Hagrid and Haros, in the city of Odia. She waits ever so patiently for your return."\n\nHe grows quiet, overwhelmed by my knowledge of his family. Fear and confusion war across his immobilized features.\n\n"So heed me, Henry. Renounce your service to Horin. Return to your happy wife and cherish her every day, because the man you speak so proudly of would not hesitate to defile her at first sight, then slaughter your children and dispose of them in the nearest river afterwards."\n\nThe truth of my words settles over him like a shroud. I release the keychain from his belt and make my way to the door, leaving him alive with his thoughts.',
    NULL
  )
  RETURNING id
),

-- Insert Continue choice for 3A
choice3a AS (
  INSERT INTO choices (scene_id, icon, choice_text, next_scene_id)
  SELECT id, '‚öîÔ∏è', 'Continue', id
  FROM scene3a
  RETURNING id
)

INSERT INTO choice_effects (choice_id, life_change, mana_change, morale_change, coin_change)
SELECT id, 0, 0, 0, 0
FROM choice3a
RETURNING *;

-- Commit the first scene group so we can continue cleanly
COMMIT;

BEGIN;

-- Scene 3B: The Violent Path
WITH scene3b AS (
  INSERT INTO scenes (title, content, image_url)
  VALUES (
    'The Violent Path (Following Choice 2)',
    '"I''m afraid you''re wrong, my friend. The shadow of death looms upon you," I say venomously, reaching for his neck as I unsheath a dagger from beneath my robe.\n\nHis eyes grow wide with terror as he desperately tries to move, but the paralysis spell holds him fast. He can only watch as I bring the blade to his throat.\n\nI hold the dagger against his skin and slowly shift it across, back and forth, cutting it open. Blood streams out, forming a dark red pool around him that stains my boots. His gurgling grows weaker, then stops entirely.\n\nAfter he falls silent, I unfasten the keys from his belt with my bloody hands and proceed towards the door. Behind me, the other guards'' curses intensify‚Äîthey witnessed everything, helpless to intervene.',
    NULL
  )
  RETURNING id
),

-- Insert Continue choice for 3B
choice3b AS (
  INSERT INTO choices (scene_id, icon, choice_text, next_scene_id)
  SELECT id, '‚öîÔ∏è', 'Continue', id
  FROM scene3b
  RETURNING id
)

INSERT INTO choice_effects (choice_id, life_change, mana_change, morale_change, coin_change)
SELECT id, 0, 0, 0, 0
FROM choice3b
RETURNING *;

COMMIT;

BEGIN;

-- Scene 3C: The Dishonorable Path
WITH scene3c AS (
  INSERT INTO scenes (title, content, image_url)
  VALUES (
    'The Dishonorable Path (Following Choice 3)',
    'I smile with immense glee and position myself beside him, unbuckling my belt.\n\n"Just what are your intentions, thief?" he asks, his voice quivering with sudden dread.\n\nI reach into my pants and withdraw my manhood. "Get away from me! Away, I say!"\n\nWith a long sigh, I release a stream of urine upon him. The warm liquid splashes across his face and chest.\n\n"You bastard! I shall end you‚ÄîI shall end you‚Äîyou abomination! You‚Äî" Most of his pathetic threats are garbled by my urine filling his mouth as he shouts.\n\nAfter draining myself, I give a little wiggle and return everything to its proper place, fastening my belt with satisfaction.\n\n"You repulsive lunatic! How dare you defile me in such a manner! Your audacity is infuriating! I''ll murder you! You filthy animal, do you hear me, thief? I''ll murder you!"\n\nI burst out into laughter, ambling towards the door after taking the keychain from his belt. Behind me, his impotent rage echoes through the corridor, joined by the disgusted shouts of the other paralyzed guards who witnessed my degrading act.',
    NULL
  )
  RETURNING id
),

-- Insert Continue choice for 3C
choice3c AS (
  INSERT INTO choices (scene_id, icon, choice_text, next_scene_id)
  SELECT id, '‚öîÔ∏è', 'Continue', id
  FROM scene3c
  RETURNING id
)

INSERT INTO choice_effects (choice_id, life_change, mana_change, morale_change, coin_change)
SELECT id, 0, 0, 0, 0
FROM choice3c
RETURNING *;

COMMIT;


// new
INSERT INTO choices 
VALUES
	(53, 40, '‚öîÔ∏è', 'Continue', 43),
	(54, 41, '‚öîÔ∏è', 'Continue', 43),
    (55, 42, '‚öîÔ∏è', 'Continue', 43),
    (56, 43, 'ü´§üí¶', 'Spit on the bastard!', 44),
    (57, 43, 'üõ°Ô∏è', 'Cast Shield', 45),
    (58, 43, 'üß†', 'Cast Mind Control', 46),
    (59, 44, '‚öîÔ∏è', 'Continue', 47),
    (60, 45, '‚öîÔ∏è', 'Continue', 47),
    (61, 46, '‚öîÔ∏è', 'Continue', 47),
    (62, 47, '‚öîÔ∏è', 'Continue', 48),
	(63, 48, '‚öîÔ∏è', 'Continue', 49);

INSERT INTO choices 
VALUES
	(29, 23, 'üò¥', 'Get some rest', 24),
	(30, 23, 'üëÄ', 'Take a potion and power on through the night!', 25),
	(31, 24, '‚öîÔ∏è', 'Continue', 26),
	(32, 25, '‚öîÔ∏è', 'Continue', 26);
INSERT INTO choices 
VALUES
	(33, 26, 'üñï', 'Respond with and insult', 27),
	(34, 26, 'ü§´', 'Tell him to be quiet', 28),
	(35, 27, '‚öîÔ∏è', 'Continue', 29),
	(36, 28, '‚öîÔ∏è', 'Continue', 29),
	(37, 29, 'üò∂‚Äçüå´Ô∏è', 'Cast Paralysis (Mana -3)', 30),
	(38, 29, 'üèπ', 'Tell Victor to use his bow', 31),
	(39, 29, 'üß†', 'Cast Mind Control (Mana -4)', 32),
	(40, 30, '‚öîÔ∏è', 'Continue', 33),
	(41, 31, '‚öîÔ∏è', 'Continue', 33),
	(42, 32, '‚öîÔ∏è', 'Continue', 33),
	(43, 33, '‚öîÔ∏è', 'Continue', 34),
	(44, 34, '‚öîÔ∏è', 'Continue', 35),
	(45, 35, '‚öîÔ∏è', 'Continue', 36),
	(46, 36, '‚öîÔ∏è', 'Attack with a sword', 37),
	(47, 36, 'üí™', 'Cast Body Enhancement (Mana -2)', 38),
	(48, 37, '‚öîÔ∏è', 'Continue', 39),
	(49, 38, '‚öîÔ∏è', 'Continue', 39),
	(50, 39, 'üî•', 'Cast Fire Blast! (Mana -4)', 40),
	(51, 39, 'üí®', 'Cast Gust (Mana -2)', 41),
	(52, 39, 'üß™', 'Cast Fireball + Smoke Potion (Mana -2)', 42);
	

INSERT INTO choices 
VALUES
	(16, 12, '‚öîÔ∏è', 'Continue', 13),
	(17, 13, '‚öîÔ∏è', 'Continue', 14),
	(18, 14, '‚öîÔ∏è', 'Continue', 15),
	(19, 15, 'üî•', 'Cast Fireball (Mana -3)', 16),
	(20, 15, 'üõ°Ô∏è', 'Cast Mage Armour (Mana -3)', 17),
	(21, 16, '‚öîÔ∏è', 'Continue', 18),
	(22, 17, '‚öîÔ∏è', 'Continue', 18),
	(23, 18, '‚öîÔ∏è', 'Continue', 19),
	(24, 19, '‚öîÔ∏è', 'Continue', 20),
	(25, 20, 'üêé', 'Trample the guard', 21),
	(26, 20, 'ü§≤', 'Spare the guard', 22),
	(27, 21, '‚öîÔ∏è', 'Continue', 23),
	(28, 22, '‚öîÔ∏è', 'Continue', 23);
	
INSERT INTO choice_effects
VALUES 
	(13, 13, 0, 0, 0, 0),
	(14, 14, 0, 0, 0, 0),
	(15, 15, 0, 0, 0, 0),
	(16, 16, -4, -3, 0, 0),
	(17, 17, -2, -3, 0, 0),
	(18, 18, 0, 0, 0, 0),
	(19, 19, 0, 0, 0, 0),
	(20, 20, 0, 0, 0, 0),
	(21, 21, 0, 0, -4, 0),
	(22, 22, 0, 0, 4, 0);

INSERT INTO choice_effects
VALUES 
	(23, 23, 0, 0, 0, 0),
	(24, 24, -100, 0, 0, 0),
	(25, 25, 0, 0, 0, 0),
	(26, 26, 10, 10, 0, 0),
	(27, 27, -1, 0, 0, 0),
	(28, 28, 0, 0, 0, 0),
	(29, 29, 0, 0, 0, 0),
	(30, 30, 0, -3, 0, 0),
	(31, 31, 0, 0, 0, 0),
	(32, 32, 0, -4, 0, 0),
	(33, 33, 0, 0, 0, 0),
	(34, 34, 0, 0, 0, 0),
	(35, 35, 0, 0, 0, 0),
	(36, 36, -2, 0, 0, 0),
	(37, 37, 0, 0, 0, 0),
	(38, 38, 0, -3, 0, 0),
	(39, 39, 0, 0, 0, 0);

INSERT INTO choice_effects
VALUES 
	(40, 40, -2, -4, 0, 0),
	(41, 41, 0, -3, 0, 0),
	(42, 42, -4, -2, 0, 0),
	(43, 43, 0, 0, 0, 0),
	(44, 44, 0, 0, 0, 0),
	(45, 45, -100, 0, 0, 0),
	(46, 46, -5, -4, 0, 0),
	(47, 47, -3, 0, 0, 0),
	(48, 48, 0, 0, 0, 0),
	(49, 49, 0, 0, 0, 0);
	
SELECT * FROM choices;

/*INSERT INTO scenes (id, title, content, image_url)
VALUES (
  50,
  'The King''s Sorcerer',
  'I release a wide spread of flames from my palms. The blaze engulfs the royal guards and the mage. I cease after a while longer only to realize after that my flames didn''t faze them. The guards had their shields raised, damn. I can tell from the glow on their shields the mage is reinforcing their defences with magic, I should have expected this, however there''s no time to wallow. One of the mage''s guards are coming. I prepare another spell but the approaching guard hurls his spear with immense power striking me right in the chest.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  51,
  'Cursed Transformation',
  'I groan as the curse''s toxic mana floods me, warping muscle and bone until I become a massive brute. Pain radiates through every limb, but it fuels me; I lunge at the guards.\n\nThe first two raise their shields, but I ram my shoulder into them and smash through their defense. I seize one and hurl him at his comrade. Two more guards surge forward while the fifth stays by the mage; blades and spears rake at me, opening fresh wounds. I swing, catching one square on the jaw, then bash him dead with his own shield. With raw, brutal force I crush another''s neck with my bare hands.\n\nThe last guard cries out, "Lady Alacross, stand behind me‚ÄîI will slay this abomination!" and waits for me to close. I grin and leap, but my hand passes through him as if he were smoke. He flickers, then fades away. "An illusion‚Äîthe witch!" I shout, straining to see the mage, but she is gone.\n\nThe curse unravels. My body shrinks back toward its former shape, the roaring power dying away, but something is wrong: numbness blooms in my legs. I try to move, and nothing answers.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  52,
  'Flash and Paralysis',
  'With a wave of my hand I unleash a bright flash of light. Blinding the royal guards, without their sight they are vulnerable as the fighters around begin to swarm around them and attack tearing them to pieces. Mutilated the five guards lie in bloody heaps on the ground as the robed sorcerer stands alone and glares at me hatefully. I smirk until suddenly my entire body goes numb and I can''t move.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  53,
  'The Sorcerer''s Gaze',
  'I start to feel a burning sensation everywhere inside me. Latched onto my right leg is a black snake, it''s fangs buried deep into my flesh. The sorcerer takes her hood off, revealing a beautiful face framed by short onyx hair and with enchanting hazel eyes she looks at me, ''Humour me before you die wizard.'' she says telepathically, in a mellow voice. For some odd reason the warriors in the area seem to be ignoring her and fight amongst themselves instead.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  54,
  'Serpent''s Embrace',
  'With great effort I grab a handful of coins from my satchel then throw them in the air pathetically. ''Take the coins and let me be you - you whore'' I say as the coins clatter on the ground. She laughs then bellows imperiously, ''Occidere eum!'' The snake transforms into a terrifying serpent with menacing red eyes then wraps itself around me. I can feel my bones breaking as it tightens it''s body around me. After crushing me it lifts me into it''s mouth with it''s forked tongue then swallows me whole.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  55,
  'The Sorcerer''s Test',
  '"Forgive me, Lord Khazakian, for I have failed you," I say telepathically, letting my voice sound hollow with feigned sorrow.\n\n"Cessare Reka," she answers, the command cutting the air in the Oxcalrian tongue. The serpent loosens its grip and slides away, but I still cannot move properly‚Äîthe poison courses through my veins, numbness and heat wrestling over my limbs.\n\nA few fighters nearby lurch toward me as if to finish the job, but at her bark they collapse, convulsing and foaming, toppled by whatever foul influence she commands. I watch the snake coil atop one of their bodies and, through gritted teeth, mutter, "What a useful creature you possess."\n\nShe leans forward, voice honeyed and dangerous. "Proclaim the words of the Holy King and Queen in their moments of death‚Äîor die." Her tone leaves no room for negotiation. She seeks proof of my fealty to the Khazakians; rumor says only their warriors truly know those last words.\n\nMy mind scrabbles for an answer. A memory surfaces‚ÄîVictor reading Rehelieu''s letter, muttering something that sounded like those lines‚Äîbut certainty slides away as quickly as it came. He might have been saying something else entirely. Safer, perhaps, to lie.\n\nI weigh my options even as the poison numbs them: speak the words I half-remember and risk exposure, or weave a convincing deception and pray it stands.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  56,
  'The Sorceress''s Mercy',
  '''Once upon a time there was a good man and a whore trapped in a room, the whore expected the man to make an attempt to woo her, but the man was strong he resisted temptation for many days. Until the whore grew tired of his resistance, so she tried to seduce him however the good man held strong. So one day she ripped his clothes off and fucked him so hard that his cock broke and he never fucked again.'' when I finished telling the story the sorceress bursts into laughter.\n\nI feel a painful stab to my shoulder from one of the fighters in the vicinity. Rapidly the snake detaches from my leg then bites the assailant, killing him instantly. ''I am still unable to move my legs the snakes venom must still be coursing within me, but wait why did that man die before me.'' I think to myself perplexed ''Because I deemed it so. I have killed a myriad of thieves today and to be honest I have grown tired of it so give me a good reason why I should not kill you where you stand.'' the sorceress says telepathically.',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  57,
  'Sacred Words Recalled',
  'I pause for a moment and strain to recall the words Victor read earlier. "If I am denied entry‚Ä¶ I will‚Ä¶" I stammer, the phrase slipping through my fingers. I close my eyes and dive deeper into memory.\n\n"If I am denied entry to heaven, then I will dance in the fires of hell," I force out‚Äîfinally finding the king''s line. The queen''s words come slower, fragmented at first: "Give me a sword and I shall‚Ä¶ and I shall‚Ä¶" I falter, mouth dry, until Victor''s voice snaps the rest into place: "I shall show you‚Äîall my hearts and souls."\n\nThe sorceress watches me with slow, cruel interest. "It is obvious you are not a Khazakian warrior, given how you struggled to recite the sacred words," she says. "Still, however flawed your recital, you succeeded. I want to know how you obtained this knowledge. For now I will let you join me as an ally‚Äîbut know this: betray me or hinder me on the battlefield, and I will kill you. And there are conditions."',
  NULL
);

INSERT INTO scenes (id, title, content, image_url)
VALUES (
  58,
  'The Serpent''s Wrath',
  '"If I die, then I will fight the gods in heaven and the demons in hell," I say, forcing confidence into my voice. "Those were the King''s words, I believe."\n\nShe scoffs; anger darkens her gorgeous face. "Then the Queen''s words were: If I do not have a heart, I will make one. If I do not have a soul, I will take one."\n\n"How dare you taint the sacred words of the Holy King and Queen with your filthy lies," she snaps, venom coiling through each syllable. "I will end you for your insolence, you irreverent scum. Reka‚Äîoccidere eum!"\n\nHer command tears the air. The snake shudders, grows, and becomes a terrible serpent with burning red eyes. Before I can move, it lunges, clamps me in its jaws, and swallows me whole.',
  NULL
);
*/

CREATE TABLE checkpoints (
    id SERIAL PRIMARY KEY,
    scene_id INTEGER REFERENCES scenes(id),
	user_id INTEGER,
    life INTEGER,
    mana INTEGER,
    morale INTEGER,
    coin INTEGER
);

ALTER TABLE scenes
ADD COLUMN is_checkpoint BOOLEAN DEFAULT FALSE;

UPDATE scenes
SET is_checkpoint = TRUE
WHERE id = 26;
SELECT * FROM scenes ORDER BY id ASC;

CREATE TABLE luck (
	id SERIAL PRIMARY KEY,
	user_id INTEGER,
	luck INTEGER
);